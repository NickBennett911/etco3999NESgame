///// METASPRITES

#define TILE 0xd8
#define ATTR 0x01
#define ATTR2 0x61

#define NUM_BULLETS 3
#define BUL_LIFETIME 20
#define BUL_SPEED 3


unsigned char row, col, byte_col, bit;

typedef struct {
  int dir;
  int speed;
  int xpos;
  int ypos;
  bool in_use;
  int lifetime;
}Bullet;

Bullet bullets[NUM_BULLETS];

void init_bullet_list() {
  int i;
  for ( i = 0; i < NUM_BULLETS; i++) {
    bullets[i].in_use = false;
    bullets[i].lifetime = BUL_LIFETIME;
    bullets[i].speed = BUL_SPEED;
  }
}

void spawn_bullet(int px, int py, int dir) {
  	int i;
	for (i = 0; i < NUM_BULLETS; i++) {
        	if (!bullets[i].in_use) {
                	bullets[i].in_use = true;
                  	bullets[i].xpos = px;
                  	bullets[i].ypos = py;
                  	bullets[i].dir = dir;
                  	bullets[i].lifetime = BUL_LIFETIME;
                  	return;
                }
        }
  	return;
}

bool active_bullet() {
  	int i;
	for (i = 0; i < NUM_BULLETS; i++) {
        	if (bullets[i].in_use) {
                	return true;
                }
        }
  	return false;
}

unsigned char collisions[96] = {
  0x00, 0x00, 0x00, 0x00,	//0-3
  0x00, 0x00, 0x00, 0x00,	//4-7
  0x00, 0x00, 0x00, 0x00,	//8-11
  0x00, 0x00, 0x00, 0x00,	//12-15
  0x00, 0x00, 0x00, 0x00,	//16-19
  0x00, 0x00, 0x00, 0x00,	//20-23
  0x00, 0x00, 0x00, 0x00,	//24-27
  0x00, 0x00, 0x00, 0x00,	//28-31
  0x00, 0x00, 0x00, 0x00,	//32-35
  0x00, 0x00, 0x00, 0x00,	//36-39
  0x00, 0x00, 0x00, 0x00,	//40-43
  0x00, 0x00, 0x00, 0x00,	//44-47
  0x00, 0x00, 0x00, 0x00,	//48-51
  0x00, 0x00, 0x00, 0x00,	//52-55
  0x00, 0x00, 0x00, 0x00,	//56-59
  0x00, 0x00, 0x00, 0x00,	//60-63
  0xff, 0xff, 0xff, 0xff,	//64-67
  0x00, 0x00, 0x00, 0x00,	//68-71
  0x00, 0x00, 0x00, 0x00,	//72-75
  0x00, 0x00, 0x00, 0x00,	//76-79
  0x00, 0x00, 0x00, 0x00,	//80-83
  0x00, 0x00, 0x00, 0x00,	//84-87
  0x00, 0x00, 0x00, 0x00,	//88-91
  0x00, 0x00, 0x00, 0x00	//92-95
};

//bool on_ground(px, py, cx, cy) {
//  
//  row = (py + 16 + cy)>>3;	//divide world 
//  col = (px + cx)>>3;
//  byte_col = col>>3;
//  bit = (col&0x0F);
//  if (collisions[row<<2 + byte_col] & (1<<bit)) {
//    return true;
//  }
//  return false;
//}

unsigned char BG_PAL[64] = { // <= should this be const?? See discussion laterâ€¦
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // rows 0-3
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // rows 4-7
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // rows 8-11
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // rows 12-15
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // rows 16-19
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // rows 20-23
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // rows 24-27
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 // rows 29-30 ("bottom" enteies are ignored)
};


const unsigned char mapt[294]={
  0x01,0x00,0x01,0x21,0x03,0x01,0x02,0x00,0x01,0x13,0x03,0x01,0x03,0x00,0x01,0x03,
  0x03,0x01,0x05,0x00,0x01,0x0f,0x03,0x01,0x06,0x00,0x01,0x02,0x03,0x01,0x07,0x00,
  0x01,0x04,0x03,0x01,0x02,0x00,0x01,0x04,0x03,0x01,0x08,0x00,0x01,0x02,0x03,0x01,
  0x06,0x00,0x01,0x02,0x03,0x01,0x05,0x00,0x01,0x03,0x03,0x01,0x08,0x00,0x01,0x03,
  0x03,0x01,0x04,0x00,0x01,0x02,0x03,0x01,0x07,0x00,0x01,0x03,0x03,0x01,0x06,0x00,
  0x01,0x0c,0x03,0x01,0x07,0x00,0x01,0x18,0x03,0x01,0x05,0x00,0x01,0x33,0xd6,0x00,
  0xd6,0x00,0xd6,0x00,0x01,0x1a,0xd7,0x00,0xd7,0x00,0xd7,0x00,0x01,0x19,0xa0,0x01,
  0x05,0x00,0x01,0x26,0xa0,0x01,0x05,0x00,0x01,0x04,0xd6,0x00,0x01,0x1e,0xd7,0x00,
  0x01,0x1b,0xa0,0x01,0x04,0x00,0x01,0x0a,0xa4,0xa5,0xa0,0x01,0x04,0xa6,0xa7,0x00,
  0x01,0x14,0xa4,0xa5,0x00,0x01,0x08,0xa6,0xa7,0x00,0x01,0x10,0xa4,0xa5,0x00,0x01,
  0x0c,0xa6,0xa7,0x00,0x01,0x08,0xf4,0xf6,0xb2,0x01,0x1c,0xf4,0xf5,0xf7,0x00,0x01,
  0x02,0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,0x04,
  0x00,0x01,0x02,0xf5,0xf4,0xf6,0x00,0x01,0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,
  0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x03,0xf4,0xf5,0xf7,0x00,0x01,
  0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,
  0x00,0x01,0x03,0xf5,0xf4,0xf6,0x00,0x01,0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,
  0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x03,0xf4,0xf5,0xf7,0x00,0x01,
  0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,
  0x00,0x01,0x03,0xf5,0x01,0x00
};



const unsigned char mapA[19]={
0x03,0x00,0x03,0xfe,0x00,0x03,0xfe,0x00,0x03,0xe1,0x02,0x03,0x5f,0x01,0x03,0x7e,
0x01,0x03,0x00
};








const unsigned char mapB[318]={
  0x01,0x00,0x01,0x2d,0xd6,0x00,0x01,0x1e,0xd7,0x00,0x01,0x0e,0xc4,0xc6,0x00,0x01,
  0x0d,0xa0,0x00,0x01,0x0e,0xc5,0xc7,0x00,0x01,0x10,0xa0,0xa0,0x00,0x01,0x08,0xa0,
  0x01,0x03,0x00,0x01,0x0a,0xa0,0x00,0x01,0x09,0xd6,0x00,0xd6,0x00,0xd6,0x00,0x01,
  0x17,0xa3,0x00,0x00,0xd7,0x00,0xd7,0x00,0xd7,0x00,0x01,0x12,0xa0,0x00,0x01,0x03,
  0xa3,0x00,0x00,0xa0,0x01,0x04,0x00,0x01,0x17,0xa3,0x00,0x01,0x05,0x03,0x01,0x02,
  0x00,0x01,0x1a,0x03,0x01,0x05,0x00,0x01,0x06,0xd6,0x00,0x01,0x02,0xd6,0x00,0x01,
  0x03,0xa0,0x01,0x04,0x00,0x01,0x03,0x03,0x01,0x06,0x00,0x01,0x06,0xd7,0x00,0x01,
  0x02,0xd7,0x00,0x01,0x0c,0x03,0x01,0x06,0x00,0x01,0x05,0xa0,0x01,0x05,0x00,0x01,
  0x0e,0x03,0x01,0x03,0x00,0x01,0x0f,0xa0,0x00,0x01,0x5a,0xa0,0x01,0x03,0x00,0x01,
  0x09,0xd6,0x00,0xd6,0x00,0x01,0x03,0xc4,0xc6,0x00,0x01,0x16,0xd7,0x00,0xd7,0x00,
  0x01,0x03,0xc5,0xc7,0xf6,0x00,0x01,0x02,0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,
  0x04,0x00,0x01,0x03,0xb2,0x01,0x04,0x00,0x01,0x02,0xf4,0xf6,0xf7,0x00,0x01,0x02,
  0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,0x04,0x00,
  0x01,0x02,0xf5,0xf7,0xf6,0x00,0x01,0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,
  0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x03,0xf4,0xf6,0xf7,0x00,0x01,0x03,
  0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,
  0x01,0x03,0xf5,0xf7,0xf6,0x00,0x01,0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,
  0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x03,0xf4,0xf6,0xf7,0xc8,0xca,0xc8,
  0xca,0xb2,0x01,0x02,0xc8,0xca,0xc8,0xca,0xc8,0xca,0xb2,0x01,0x02,0xc8,0xca,0xc8,
  0xca,0xc8,0xca,0xb2,0x01,0x02,0xc8,0xca,0xc8,0xca,0xf5,0xf7,0x01,0x00
};

// define an array of 2x2 metasprites
const unsigned char anim_right[5][17] = {
  { //0
        0,      0,      TILE+0,   ATTR, 
        0,      8,      TILE+1,   ATTR, 
        8,      0,      TILE+2,   ATTR, 
        8,      8,      TILE+3,   ATTR, 
        128},
  { //1
        0,      0,      0xe0+0,   ATTR, 
        0,      8,      0xe0+1,   ATTR, 
        8,      0,      0xe0+2,   ATTR, 
        8,      8,      0xe0+3,   ATTR, 
        128},
  { //2
        0,      0,      0xdc+0,   ATTR, 
        0,      8,      0xdc+1,   ATTR, 
        8,      0,      0xdc+2,   ATTR, 
        8,      8,      0xdc+3,   ATTR, 
        128},
  { //3
        0,      0,      0xe4+0,   ATTR, 
        0,      8,      0xe4+1,   ATTR, 
        8,      0,      0xe4+2,   ATTR, 
        8,      8,      0xe4+3,   ATTR, 
        128},
  { //4
        0,      0,      0xe8+0,   ATTR, 
        0,      8,      0xe8+1,   ATTR, 
        8,      0,      0xe8+2,   ATTR, 
        8,      8,      0xe8+3,   ATTR, 
        128}
  
};

const unsigned char jump_right[] = {
        0,      0,      0xe8+0,   ATTR, 
        0,      8,      0xe8+1,   ATTR, 
        8,      0,      0xe8+2,   ATTR, 
        8,      8,      0xe8+3,   ATTR, 
        128};

const unsigned char jump_left[] = {
        8,      0,      0xe8+0,   ATTR2, 
        8,      8,      0xe8+1,   ATTR2, 
        0,      0,      0xe8+2,   ATTR2, 
        0,      8,      0xe8+3,   ATTR2, 
        128};

const unsigned char anim_left[5][17] = {
  { //0
        8,      0,      TILE+0,   ATTR2, 
        8,      8,      TILE+1,   ATTR2, 
        0,      0,      TILE+2,   ATTR2, 
        0,      8,      TILE+3,   ATTR2, 
        128},
  { //1
        8,      0,      0xe0+0,   ATTR2, 
        8,      8,      0xe0+1,   ATTR2, 
        0,      0,      0xe0+2,   ATTR2, 
        0,      8,      0xe0+3,   ATTR2, 
        128},
  { //2
        8,      0,      0xdc+0,   ATTR2, 
        8,      8,      0xdc+1,   ATTR2, 
        0,      0,      0xdc+2,   ATTR2, 
        0,      8,      0xdc+3,   ATTR2, 
        128},
  { //3
        8,      0,      0xe4+0,   ATTR2, 
        8,      8,      0xe4+1,   ATTR2, 
        0,      0,      0xe4+2,   ATTR2, 
        0,      8,      0xe4+3,   ATTR2, 
        128},
  { //4
        8,      0,      0xe8+0,   ATTR2, 
        8,      8,      0xe8+1,   ATTR2, 
        0,      0,      0xe8+2,   ATTR2, 
        0,      8,      0xe8+3,   ATTR2, 
        128}
  
};

const char PALETTE[32] =
{
  0x03, // screen color
  0x24, 0x20, 0x20, 0x0, // background palette 0
  0x1c, 0x20, 0x2c, 0x0, // background palette 1
  0x00, 0x1a, 0x20, 0x0, // background palette 2
  0x06, 0x03, 0x06, 0x0, // background palette 3
  0x23, 0x31, 0x06, 0x0, // sprite palette 0
  0x00, 0x37, 0x25, 0x0, // sprite palette 1
  0x36, 0x21, 0x19, 0x0, // sprite palette 2
  0x1d, 0x37, 0x2b, // sprite palette 3
};
