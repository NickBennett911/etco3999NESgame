#define NES_MIRRORING 1

#include "neslib.h"
#include "vrambuf.h"
#include "bcd.h"


// link the pattern table into CHR ROM
//#link "chr_generic.s"
//#link "vrambuf.c"

///// METASPRITES

#define TILE 0xd8
#define ATTR 0x01
#define ATTR2 0x61

const unsigned char mapA[294]={
0x01,0x00,0x01,0x21,0x03,0x01,0x02,0x00,0x01,0x13,0x03,0x01,0x03,0x00,0x01,0x03,
0x03,0x01,0x05,0x00,0x01,0x0f,0x03,0x01,0x06,0x00,0x01,0x02,0x03,0x01,0x07,0x00,
0x01,0x04,0x03,0x01,0x02,0x00,0x01,0x04,0x03,0x01,0x08,0x00,0x01,0x02,0x03,0x01,
0x06,0x00,0x01,0x02,0x03,0x01,0x05,0x00,0x01,0x03,0x03,0x01,0x08,0x00,0x01,0x03,
0x03,0x01,0x04,0x00,0x01,0x02,0x03,0x01,0x07,0x00,0x01,0x03,0x03,0x01,0x06,0x00,
0x01,0x0c,0x03,0x01,0x07,0x00,0x01,0x18,0x03,0x01,0x05,0x00,0x01,0x33,0xd6,0x00,
0xd6,0x00,0xd6,0x00,0x01,0x1a,0xd7,0x00,0xd7,0x00,0xd7,0x00,0x01,0x19,0xa0,0x01,
0x05,0x00,0x01,0x26,0xa0,0x01,0x05,0x00,0x01,0x04,0xd6,0x00,0x01,0x1e,0xd7,0x00,
0x01,0x1b,0xa0,0x01,0x04,0x00,0x01,0x0a,0xa4,0xa5,0xa0,0x01,0x04,0xa6,0xa7,0x00,
0x01,0x14,0xa4,0xa5,0x00,0x01,0x08,0xa6,0xa7,0x00,0x01,0x10,0xa4,0xa5,0x00,0x01,
0x0c,0xa6,0xa7,0x00,0x01,0x08,0xf4,0xf6,0xb2,0x01,0x1c,0xf4,0xf5,0xf7,0x00,0x01,
0x02,0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,0x04,
0x00,0x01,0x02,0xf5,0xf4,0xf6,0x00,0x01,0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,
0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x03,0xf4,0xf5,0xf7,0x00,0x01,
0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,
0x00,0x01,0x03,0xf5,0xf4,0xf6,0x00,0x01,0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,
0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x03,0xf4,0xf5,0xf7,0x00,0x01,
0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,
0x00,0x01,0x03,0xf5,0x01,0x00
};

const unsigned char mapB[318]={
0x01,0x00,0x01,0x2d,0xd6,0x00,0x01,0x1e,0xd7,0x00,0x01,0x0e,0xc4,0xc6,0x00,0x01,
0x0d,0xa0,0x00,0x01,0x0e,0xc5,0xc7,0x00,0x01,0x10,0xa0,0xa0,0x00,0x01,0x08,0xa0,
0x01,0x03,0x00,0x01,0x0a,0xa0,0x00,0x01,0x09,0xd6,0x00,0xd6,0x00,0xd6,0x00,0x01,
0x17,0xa3,0x00,0x00,0xd7,0x00,0xd7,0x00,0xd7,0x00,0x01,0x12,0xa0,0x00,0x01,0x03,
0xa3,0x00,0x00,0xa0,0x01,0x04,0x00,0x01,0x17,0xa3,0x00,0x01,0x05,0x03,0x01,0x02,
0x00,0x01,0x1a,0x03,0x01,0x05,0x00,0x01,0x06,0xd6,0x00,0x01,0x02,0xd6,0x00,0x01,
0x03,0xa0,0x01,0x04,0x00,0x01,0x03,0x03,0x01,0x06,0x00,0x01,0x06,0xd7,0x00,0x01,
0x02,0xd7,0x00,0x01,0x0c,0x03,0x01,0x06,0x00,0x01,0x05,0xa0,0x01,0x05,0x00,0x01,
0x0e,0x03,0x01,0x03,0x00,0x01,0x0f,0xa0,0x00,0x01,0x5a,0xa0,0x01,0x03,0x00,0x01,
0x09,0xd6,0x00,0xd6,0x00,0x01,0x03,0xc4,0xc6,0x00,0x01,0x16,0xd7,0x00,0xd7,0x00,
0x01,0x03,0xc5,0xc7,0xf6,0x00,0x01,0x02,0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,
0x04,0x00,0x01,0x03,0xb2,0x01,0x04,0x00,0x01,0x02,0xf4,0xf6,0xf7,0x00,0x01,0x02,
0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,0x04,0x00,0x01,0x03,0xb2,0x01,0x04,0x00,
0x01,0x02,0xf5,0xf7,0xf6,0x00,0x01,0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,
0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x03,0xf4,0xf6,0xf7,0x00,0x01,0x03,
0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,
0x01,0x03,0xf5,0xf7,0xf6,0x00,0x01,0x03,0xb2,0x01,0x02,0x00,0x01,0x05,0xb2,0x01,
0x02,0x00,0x01,0x05,0xb2,0x01,0x02,0x00,0x01,0x03,0xf4,0xf6,0xf7,0xc8,0xca,0xc8,
0xca,0xb2,0x01,0x02,0xc8,0xca,0xc8,0xca,0xc8,0xca,0xb2,0x01,0x02,0xc8,0xca,0xc8,
0xca,0xc8,0xca,0xb2,0x01,0x02,0xc8,0xca,0xc8,0xca,0xf5,0xf7,0x01,0x00
};





// define a 2x2 metasprite
const unsigned char right[]={
        0,      0,      TILE+0,   ATTR, 
        0,      8,      TILE+1,   ATTR, 
        8,      0,      TILE+2,   ATTR, 
        8,      8,      TILE+3,   ATTR, 
        128};

const unsigned char left[]={
        8,      0,      TILE+0,   ATTR2, 
        8,      8,      TILE+1,   ATTR2, 
        0,      0,      TILE+2,   ATTR2, 
        0,      8,      TILE+3,   ATTR2, 
        128};

const unsigned char door[]={
        0,      0,      0xc4+0,   ATTR, 
        0,      8,      0xc4+1,   ATTR, 
        8,      0,      0xc4+2,   ATTR, 
        8,      8,      0xc4+3,   ATTR, 
        128};

const unsigned char anim[2][17] = {
  { // left
        0,      0,      0xc4+0,   ATTR, 
        0,      8,      0xc4+1,   ATTR, 
        8,      0,      0xc4+2,   ATTR, 
        8,      8,      0xc4+3,   ATTR, 
        128},
  { // door
        8,      0,      TILE+0,   ATTR2, 
        8,      8,      TILE+1,   ATTR2, 
        0,      0,      TILE+2,   ATTR2, 
        0,      8,      TILE+3,   ATTR2, 
        128}
  
};

const char PALETTE[32] =
{
  0x03, // screen color
  0x24, 0x16, 0x20, 0x0, // background palette 0
  0x1c, 0x20, 0x2c, 0x0, // background palette 1
  0x00, 0x1a, 0x20, 0x0, // background palette 2
  0x06, 0x03, 0x06, 0x0, // background palette 3
  0x23, 0x31, 0x06, 0x0, // sprite palette 0
  0x00, 0x37, 0x25, 0x0, // sprite palette 1
  0x36, 0x21, 0x19, 0x0, // sprite palette 2
  0x1d, 0x37, 0x2b, // sprite palette 3
};

// main function, run after console reset
void main(void) {

  unsigned char p_x = 30, p_y = 160;
  int i;
  int dir = 0;
  int speed = 1;
  int idle_dir = 1;
  unsigned char attrib = 0x00;
  
  int screen_x = -8, screen_y = 0;
  int right_side = 0, left_side = 1;
  int is_player_control = 1;
  
  int anim_state = 0;
  
  // set palette colors
  pal_all(PALETTE); // generally before game loop (in main)
  
  vram_adr(NTADR_A(1, 1));
  vram_write("HEALTH: ", 8);
  for ( i = 0; i < 10; i++) {
  	vram_put(0x15);
  }
  
  vram_adr(NTADR_A(0,4)); // Zelda probably started at 0x28d0 (8 rows below stats area)
  vram_unrle(mapA); // my map01 is an array of 274 unsigned char's
  
  vram_adr(NTADR_B(0,4)); // Zelda probably started at 0x28d0 (8 rows below stats area)
  vram_unrle(mapB); // my map01 is an array of 274 unsigned char's
  
  // enable PPU rendering (turn on screen)
  ppu_on_all();

  vrambuf_clear();
  set_vram_update((byte*)0x100); // updbuf = 0x100 -- start of stack RAM
  
  // infinite loop
  while (1) 
  {
    char cur_oam = 0;
    char pad_result = pad_poll(0);
    
    
    if(pad_result&(0x01<<6)){	// left
    	dir = -1;
    	idle_dir = -1;
    } else if (pad_result&(0x01<<7)) { 	// right
    	dir = 1;
      	idle_dir = 1;
    } else {
      dir = 0;
    }
    
    if (p_x >= 232) {
        speed = 1;
      	p_x = 232;
      //attrib |= 0x60;	// makes bit 6 one to flip
    } else if (p_x <= 8) {
        speed = 1;
      	p_x = 8;
      //attrib &= 0x00;	// makes bit 6 zero to flip
    }
    if (is_player_control) {
    	p_x += speed * dir;
       
      	if (p_x >= 128 && left_side) {
        	is_player_control = 0;
          	left_side = 0;
        }
        if (p_x <= 128 && right_side) {
        	is_player_control = 0;
          	right_side = 0;
        }
    } else {
    	screen_x += speed * dir;
      	if (screen_x <= -8) {
        	is_player_control = 1;
          	left_side = 1;
          	right_side = 0;
        } else if (screen_x >= 264) {
        	is_player_control = 1;
          	right_side = 1;
          	left_side = 0;
        }
    }
    
    
    
    if (dir == 1) {
      cur_oam = oam_meta_spr(p_x, p_y, cur_oam, anim[anim_state%2]);
      anim_state++;
    } else  if (dir == -1) {
      cur_oam = oam_meta_spr(p_x, p_y, cur_oam, anim[anim_state%2]);
      anim_state++;
    } else{
    	if (idle_dir == 1) {
          cur_oam = oam_meta_spr(p_x, p_y, cur_oam, right);
        } else if (idle_dir == -1) {
          cur_oam = oam_meta_spr(p_x, p_y, cur_oam, left);
        }
    }
    scroll(screen_x, screen_y);
    vrambuf_flush();
    
  }
}
